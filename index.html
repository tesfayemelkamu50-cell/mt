<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIZZY 12 | Ultimate Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2ecc71; --danger: #e74c3c; --accent: #00d2ff; --bg: #05050a; --card-bg: #111122; --gold: #ffd700; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; overflow-x: hidden; }
        .container { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 1fr 360px; gap: 20px; margin: 0 auto; }
        @media (max-width: 950px) { .container { grid-template-columns: 1fr; } }

        /* Timer & Status */
        .timer-box { font-size: 4rem; font-weight: 900; text-align: center; color: var(--primary); text-shadow: 0 0 20px var(--primary); margin-bottom: 5px; }
        .status-bar { background: #1a1a2e; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px; border: 1px solid #333; font-size: 0.9rem; }

        /* Grid & Beautiful Model Cards */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 15px 0; }
        .num-card { position: relative; height: 160px; background-size: cover; background-position: center; border-radius: 15px; cursor: pointer; border: 2px solid #252545; transition: 0.3s; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .num-card:hover { border-color: var(--accent); transform: scale(1.03); z-index: 5; }
        .card-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9) 15%, transparent 60%); display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 12px; }
        .num-text { font-weight: 900; font-size: 2rem; text-shadow: 2px 2px 8px rgba(0,0,0,0.8); margin-bottom: 2px; }
        .odd-badge { background: var(--primary); color: black; font-weight: 900; padding: 2px 10px; border-radius: 5px; font-size: 0.85rem; }

        /* Shop-Wide Winner Reveal */
        #win-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); width: 85%; max-width: 420px; background: linear-gradient(135deg, #0a0a19, #000); border: 4px solid var(--gold); border-radius: 20px; z-index: 1000; padding: 30px; text-align: center; transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 100px rgba(255, 215, 0, 0.2); }
        #win-popup.show { transform: translate(-50%, -50%) scale(1); }
        .winner-model-host { position: absolute; top: -110px; left: 50%; transform: translateX(-50%); width: 260px; filter: drop-shadow(0 0 15px var(--gold)); opacity: 0; transition: 1s; }
        #win-popup.show .winner-model-host { opacity: 1; }
        .big-number-reveal { font-size: 5rem; font-weight: 900; color: var(--gold); text-shadow: 0 0 30px var(--gold); display: block; margin: 10px 0; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        /* Personal Win Alert (For Winner's Phone) */
        #personal-win-alert { position: fixed; bottom: -150px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: linear-gradient(45deg, #ffd700, #ffae00); color: #000; padding: 20px; border-radius: 15px; text-align: center; font-weight: bold; box-shadow: 0 -5px 30px rgba(255, 215, 0, 0.5); z-index: 2000; transition: 0.5s ease-in-out; }
        #personal-win-alert.active { bottom: 20px; }

        /* Admin Styles */
        .admin-side { background: var(--card-bg); padding: 20px; border-radius: 20px; border: 1px solid #333; height: fit-content; }
        .hidden { display: none !important; }
        .req-card { background: #05050a; padding: 12px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--accent); }
        .btn-draw { width: 100%; background: linear-gradient(45deg, #ffd700, #ffae00); color: black; padding: 14px; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; margin-top: 15px; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="win-popup">
        <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3ZqOHB6bmR6Z3Z6OHB6bmR6Z3Z6OHB6bmR6Z3Z6OHB6bmR6JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1z/l41lI4bEBpG2LQXuw/giphy.gif" class="winner-model-host">
        <div style="margin-top: 60px;">
            <small style="color: var(--gold); letter-spacing: 3px;">WINNING NUMBER</small>
            <span class="big-number-reveal" id="popup-num">#0</span>
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; border: 1px solid rgba(255,215,0,0.2);">
                <small style="color: #aaa;">WINNER ID</small>
                <div style="font-size: 1.8rem; font-weight: 900;" id="popup-id">...</div>
                <div style="color: var(--primary); font-size: 2rem; font-weight: 900; margin-top: 5px;">
                    <span id="popup-prize">0</span> <small>ETB</small>
                </div>
            </div>
        </div>
    </div>

    <div id="personal-win-alert">
        <div style="font-size: 1.5rem;">ðŸŽ‰ YOU WON! ðŸŽ‰</div>
        <p>Show this screen to the counter to claim your prize.</p>
        <button onclick="this.parentElement.classList.remove('active')" style="background:#000; color:#fff; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">I'M COMING!</button>
    </div>

    <div class="container">
        <div class="game-side">
            <div id="timer" class="timer-box">00:00</div>
            <div class="status-bar">PLAYER ID: <b id="display-id" style="color:var(--accent)">...</b></div>
            <div class="grid" id="grid"></div>
        </div>

        <div class="admin-side">
            <h3 onclick="unlockAdmin()" style="cursor:pointer; text-align:center; color:#555; font-size:0.9rem;">ðŸ”’ ADMIN DASHBOARD</h3>
            <div id="admin-content" class="hidden">
                <div style="background:#000; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #222; text-align:center;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div><small style="color:#888">IN</small><br><span id="total-in" style="color:var(--accent); font-weight:bold;">0</span></div>
                        <div><small style="color:#888">OUT</small><br><span id="total-out" style="color:var(--danger); font-weight:bold;">0</span></div>
                    </div>
                    <div style="margin-top:10px; border-top:1px solid #222; padding-top:10px;">
                        <small style="color:#888">NET PROFIT</small><br>
                        <span id="rev-display" style="color:var(--primary); font-size:1.8rem; font-weight:bold;">0</span> <small>ETB</small>
                    </div>
                </div>

                <div style="margin-bottom:15px;">
                    <small style="color:#888">PRICE PER TICKET:</small>
                    <div style="display:flex; gap:8px; margin-top:5px;">
                        <input type="number" id="set-price" value="20" style="width:70px; background:#000; color:#fff; border:1px solid #444; padding:8px; border-radius:5px;">
                        <button onclick="updateCloudPrice()" style="flex:1; background:var(--accent); border:none; border-radius:5px; font-weight:bold; cursor:pointer; color:#000;">SYNC</button>
                    </div>
                </div>

                <h4 style="margin-bottom:10px; font-size:0.8rem; color:var(--accent);">PENDING PAYMENTS</h4>
                <div id="request-queue"></div>
                
                <button onclick="triggerDraw()" class="btn-draw">DRUMROLL & DRAW</button>
                <button onclick="resetDailyStats()" style="width:100%; background:none; border:1px solid #444; color:#666; margin-top:15px; padding:6px; border-radius:5px; cursor:pointer; font-size:0.7rem;">RESET DAY</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fixevmectotnqrwkupvp.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_4SWF8XqX8s5Eut93C3wMOA_dLOZQ2Vq';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let myID = localStorage.getItem('fizzy_player_id') || "PX-" + Math.floor(100 + Math.random() * 899);
        localStorage.setItem('fizzy_player_id', myID);
        document.getElementById('display-id').innerText = myID;

        let odds = Array(13).fill(2.0), ticketPrice = 20, sessionIn = 0, sessionOut = 0, isAdmin = false;

        function initGrid() {
            const grid = document.getElementById('grid'); grid.innerHTML = '';
            const models = [
                "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1503342217505-b0a15ec3261c?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1509631179647-0177331693ae?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1488426862026-3ee34a7d66df?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1534528741775-53994a69daeb?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1529139513055-1197978975b6?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1581044777550-4cfa60707c03?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?auto=format&fit=crop&w=400&q=80",
                "https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=400&q=80"
            ];
            for(let i=1; i<=12; i++) {
                odds[i] = (1.5 + (Math.abs(Math.sin(i)) * 9.5)).toFixed(1);
                grid.innerHTML += `<div class="num-card" style="background-image: url('${models[i-1]}')" onclick="placeBet(${i})"><div class="card-overlay"><span class="num-text">#${i}</span><div class="odd-badge">${odds[i]}x</div></div></div>`;
            }
        }

        async function placeBet(n) {
            if(!confirm(`Join #${n} for ${ticketPrice} ETB?`)) return;
            const { error } = await _supabase.from('bets').insert([{ player_id: myID, number: n, odd: parseFloat(odds[n]), status: 'pending', price: ticketPrice }]);
            if(!error) alert("âœ… Sent! Pay at counter.");
        }

        async function verifyBet(id, price) {
            await _supabase.from('bets').update({ status: 'paid' }).eq('id', id);
            sessionIn += price; updateAccountingUI(); fetchPendingBets();
        }

        async function triggerDraw() {
            const { data: paidBets } = await _supabase.from('bets').select('*').eq('status', 'paid');
            const winNum = Math.floor(Math.random() * 12) + 1;
            let winner = paidBets ? paidBets.find(b => b.number === winNum) : null;
            let prize = winner ? (winner.odd * winner.price) : 0;
            sessionOut += prize;
            await _supabase.from('game_state').update({ last_winner_id: winner ? winner.player_id : 'NO WINNER', last_win_num: winNum, prize: prize }).eq('id', 1);
            updateAccountingUI(); await _supabase.from('bets').delete().neq('id', 0);
        }

        async function updateCloudPrice() {
            const newPrice = parseInt(document.getElementById('set-price').value);
            await _supabase.from('game_state').update({ ticket_price: newPrice }).eq('id', 1);
        }

        _supabase.channel('room1').on('postgres_changes', { event: '*', schema: 'public', table: 'bets' }, () => isAdmin && fetchPendingBets())
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'game_state' }, payload => {
                if(payload.new.ticket_price) ticketPrice = payload.new.ticket_price;
                showWinner(payload.new);
            }).subscribe();

        function showWinner(data) {
            new Audio('https://assets.mixkit.co/active_storage/sfx/2021/2021-preview.mp3').play();
            document.getElementById('popup-num').innerText = "#" + data.last_win_num;
            document.getElementById('popup-id').innerText = data.last_winner_id;
            document.getElementById('popup-prize').innerText = Math.floor(data.prize);
            document.getElementById('win-popup').classList.add('show');
            if (data.last_winner_id === myID) {
                document.getElementById('personal-win-alert').classList.add('active');
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
            setTimeout(() => { 
                document.getElementById('win-popup').classList.remove('show'); 
                document.getElementById('personal-win-alert').classList.remove('active');
                initGrid(); 
            }, 10000);
        }

        async function fetchPendingBets() {
            const { data } = await _supabase.from('bets').select('*').eq('status', 'pending');
            const q = document.getElementById('request-queue');
            q.innerHTML = data.length ? data.map(b => `<div class="req-card"><div><b>${b.player_id}</b> (#${b.number})</div><button onclick="verifyBet(${b.id}, ${b.price})" style="background:var(--primary);border:none;color:white;padding:8px;border-radius:5px;cursor:pointer;">PAID</button></div>`).join('') : '<p style="text-align:center;color:#444">No requests</p>';
        }

        function unlockAdmin() { if(prompt("PIN:") === "1234") { isAdmin = true; document.getElementById('admin-content').classList.remove('hidden'); fetchPendingBets(); } }
        function updateAccountingUI() { document.getElementById('total-in').innerText = sessionIn; document.getElementById('total-out').innerText = sessionOut; document.getElementById('rev-display').innerText = (sessionIn - sessionOut).toFixed(0); }
        function resetDailyStats() { if(confirm("Reset?")) { sessionIn = 0; sessionOut = 0; updateAccountingUI(); } }
        
        setInterval(() => {
            let sec = 59 - new Date().getSeconds();
            document.getElementById('timer').innerText = `0:${sec < 10 ? '0' : ''}${sec}`;
            if(sec === 0 && isAdmin) triggerDraw();
        }, 1000);

        initGrid();
    </script>
</body>
</html>